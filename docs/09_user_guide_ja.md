# JAIA ユーザー操作マニュアル

Journal entry AI Analyzer（JAIA）の操作方法を説明します。

---

## 目次

1. [起動方法](#1-起動方法)
2. [画面構成](#2-画面構成)
3. [データの取り込み](#3-データの取り込み)
4. [ダッシュボード](#4-ダッシュボード)
5. [リスク分析](#5-リスク分析)
6. [AI分析](#6-ai分析)
7. [レポート生成](#7-レポート生成)
8. [設定](#8-設定)
9. [よくある質問](#9-よくある質問)

---

## 1. 起動方法

### ワンクリック起動（推奨）

プロジェクトルートで以下のいずれかを実行します。

```powershell
# PowerShell
.\start.ps1

# または start.bat をダブルクリック
```

バックエンド（API）とフロントエンド（画面）が自動で起動します。

### 手動起動

2つのターミナルを開いて、それぞれ実行します。

**ターミナル1（バックエンド）:**

```powershell
cd backend
.\venv\Scripts\Activate.ps1
python -m uvicorn app.main:app --host 127.0.0.1 --port 8090 --reload
```

**ターミナル2（フロントエンド）:**

```powershell
cd frontend
npm run dev
```

### アクセス先

| サービス | URL |
| ------- | --- |
| フロントエンド | `http://localhost:5290` |
| バックエンド API | `http://localhost:8090` |
| Swagger UI | `http://localhost:8090/docs`（DEBUG=true時のみ） |

### 終了方法

起動時に開いたターミナルウィンドウを閉じるか、`Ctrl+C` で停止します。

---

## 2. 画面構成

アプリケーションは左側のサイドバーで画面を切り替えます。

| 画面 | アイコン | 説明 |
| ---- | ------- | ---- |
| ダッシュボード | 📊 | KPI・リスク分布・時系列・Benford分析 |
| データ取込 | 📁 | CSV/Excelファイルのインポート |
| リスク分析 | ⚠️ | 違反一覧・リスクスコア詳細 |
| AI分析 | 🤖 | AIエージェントとの対話型分析 |
| レポート | 📋 | 監査報告書の生成・ダウンロード |
| 設定 | ⚙️ | LLMプロバイダー・表示設定 |

画面左下にバックエンドとの接続状態が表示されます。

- 🟢 **接続中**: 正常に動作
- 🔴 **切断**: バックエンドが停止しています → 再起動してください

---

## 3. データの取り込み

### 対応フォーマット

| 形式 | 拡張子 | 備考 |
| ---- | ------ | ---- |
| CSV | `.csv` | UTF-8 または Shift_JIS |
| Excel | `.xlsx`, `.xls` | 先頭シートを読込 |

### ファイルサイズ上限

- 直接アクセス時: 制限なし（メモリ依存）
- nginx経由時: 100MB

### 取込手順

#### Step 1: ファイルアップロード

1. サイドバーの「データ取込」をクリック
2. ファイルをドラッグ＆ドロップ、または「ファイルを選択」ボタン
3. アップロードが完了するとプレビューが表示されます

#### Step 2: カラムマッピング

アップロードしたファイルのカラムと、JAIAの標準カラムの対応を確認します。
自動マッピングが提案されますが、必要に応じて手動で修正できます。

**JAIA標準カラム（AICPA GL_Detail準拠）:**

| カラム | 必須 | 説明 |
| ------ | ---- | ---- |
| `journal_id` | ◎ | 仕訳番号 |
| `entry_date` | ◎ | 仕訳日（YYYY-MM-DD） |
| `account_code` | ◎ | 勘定科目コード |
| `debit_amount` | ◎ | 借方金額 |
| `credit_amount` | ◎ | 貸方金額 |
| `description` | ○ | 摘要 |
| `created_by` | ○ | 作成者 |
| `approved_by` | ○ | 承認者 |
| `business_unit_code` | ○ | 部門コード |
| `fiscal_year` | ○ | 会計年度 |

#### Step 3: バリデーション

「バリデーション」ボタンをクリックすると、データの整合性チェックが実行されます。

- **エラー**（赤）: 取込不可。修正が必要
- **警告**（黄）: 取込可能だが確認推奨

#### Step 4: 取込実行

「取込開始」をクリックしてインポートを実行します。
完了後、ダッシュボードに反映されます。

### マスタデータの取込

マスタデータ（勘定科目表・部門・取引先・ユーザー）は別途取り込みます。
`sample_data/` 内のファイルを参考にしてください。

| ファイル | 内容 |
| ------- | ---- |
| `01_chart_of_accounts.csv` | 勘定科目マスタ |
| `02_department_master.csv` | 部門マスタ |
| `03_vendor_master.csv` | 取引先マスタ |
| `04_user_master.csv` | ユーザーマスタ |

---

## 4. ダッシュボード

データ取込後、自動でダッシュボードに分析結果が表示されます。

### KPIカード（画面上部）

| カード | 説明 |
| ------ | ---- |
| 仕訳件数 | 分析対象の総仕訳数 |
| 総取引金額 | 借方・貸方の合計金額 |
| 高リスク項目 | リスクスコア60以上の件数 |
| 異常検知件数 | ML異常検知の件数 |
| ユニーク勘定科目数 | 使用されている勘定科目の種類数 |

### チャート

#### 月次推移チャート

- X軸: 月、Y軸: 取引金額
- 期末集中や異常な変動を確認

#### リスク分布チャート

- 円グラフでリスクレベル別の件数を表示
- Critical（赤）> High（橙）> Medium（青）> Low（緑）

#### Benford分析チャート

- 棒グラフで先頭桁の出現頻度を表示
- 実績値と理論値（Benfordの法則）を比較
- 乖離が大きい場合は数値操作の可能性

#### 勘定科目別分析

- 借方・貸方の上位科目を表示
- 金額の偏りを確認

### 期間フィルタ

画面上部の会計年度セレクタで対象年度を切り替えます。

---

## 5. リスク分析

### 58の監査ルール

JAIAは6カテゴリ・58種類の監査ルールで仕訳データを検証します。

| カテゴリ | ルール数 | 検出例 |
| ------- | ------- | ------ |
| 金額（AMT） | 12 | 重要性基準超過、端数異常、丸め金額、金額急増 |
| 時間（TIM） | 10 | 営業時間外、週末・祝日、期末集中 |
| 勘定科目（ACC） | 10 | 異常科目組合せ、通常と異なる相手科目 |
| 承認（APR） | 10 | 自己承認、権限超過、承認遅延 |
| ML異常検知（ML） | 6 | Isolation Forest、LOF、Autoencoder |
| Benford（BEN） | 10 | 第1桁・第2桁の分布異常 |

### リスクスコア

| スコア | レベル | 対応 |
| ------ | ------ | ---- |
| 80-100 | Critical | 即時調査が必要 |
| 60-79 | High | 優先的に確認 |
| 40-59 | Medium | 通常の確認対象 |
| 0-39 | Low | 低リスク |

### 違反一覧の操作

1. サイドバーの「リスク分析」をクリック
2. フィルタで絞り込み:
   - **リスクレベル**: Critical / High / Medium / Low
   - **ルールカテゴリ**: 金額 / 時間 / 勘定科目 / 承認 / ML / Benford
   - **期間**: 会計期間の範囲指定
3. 各違反行をクリックして詳細を確認

### バッチ処理の実行

大量データに対してルール検証・ML分析を実行するには:

1. サイドバーの設定 → 「バッチ処理」
2. 処理モードを選択:
   - **full**: 全ルール + ML分析（推奨）
   - **quick**: 高速ルールのみ
   - **rules_only**: ルールエンジンのみ
   - **ml_only**: ML異常検知のみ
3. 「実行」をクリック

---

## 6. AI分析

AI分析画面では、5種類のAIエージェントが仕訳データを自律的に分析します。

### AIエージェント一覧

| エージェント | 説明 | 使用例 |
| ----------- | ---- | ------ |
| 分析エージェント | パターン分析、高リスク領域の特定 | 「期末仕訳のリスク傾向を分析して」 |
| 調査エージェント | 特定仕訳の深掘り調査 | 「ユーザーAの自己承認を調査して」 |
| 文書化エージェント | 監査ドキュメント生成 | 「分析結果をサマリーにまとめて」 |
| QAエージェント | 質問応答、データ説明 | 「高リスク仕訳の件数は？」 |
| レビューエージェント | 所見レビュー、優先順位付け | 「検出事項に優先順位をつけて」 |

### 使い方

1. サイドバーの「AI分析」をクリック
2. テキストボックスに質問を入力
3. Enterキーまたは送信ボタンで実行
4. AIが分析を実行し、結果を表示

### 質問例

```text
2024年度の高リスク仕訳を説明してください
期末に集中している異常仕訳を調べて
自己承認パターンの傾向は？
勘定科目「交際費」の異常を分析して
今回の分析結果をレポートにまとめて
```

### 注意事項

- LLMプロバイダーの設定が必要です（設定画面で確認）
- 応答に5〜30秒かかる場合があります
- 複雑な分析はマルチエージェントワークフローで自動実行されます

---

## 7. レポート生成

### 利用可能なテンプレート

| テンプレート | 説明 | 形式 |
| ----------- | ---- | ---- |
| サマリーレポート | 検証結果の概要 | JSON / PPT / PDF |
| 詳細レポート | カテゴリ別の詳細分析 | JSON / PPT / PDF |
| エグゼクティブサマリー | 経営陣向け要約 | JSON / PPT / PDF |
| 違反一覧レポート | 検出された違反の一覧表 | JSON / CSV |
| リスク分析レポート | リスクスコア分布の詳細 | JSON / PPT |
| Benford分析レポート | 数値分布の分析結果 | JSON / PPT |
| 監査調書 | 監査手続と結果の記録 | JSON / PPT / PDF |

### 生成手順

1. サイドバーの「レポート」をクリック
2. テンプレートを選択
3. パラメータを設定（対象年度、期間、含める項目）
4. 「生成」をクリック
5. ダウンロードボタンで取得（PPT / PDF）

### PowerPointレポート

- グラフ付きの監査報告書が自動生成されます
- ダウンロード後、Microsoft PowerPoint / Google Slides で編集可能
- 会社名やロゴは手動で差し替えてください

---

## 8. 設定

設定画面では以下を変更できます。

### LLMプロバイダー設定

- プロバイダーの選択（8種類対応）
- APIキーの設定
- 接続テスト

### 表示設定

- 会計年度のデフォルト
- 通貨表示形式
- 言語設定

---

## 9. よくある質問

### Q: データが表示されません

**A:** 以下を確認してください:

1. バックエンドが起動しているか（画面左下の接続状態）
2. データ取込が完了しているか
3. 会計年度フィルタが正しいか
4. ブラウザをリロード（F5）

### Q: AI分析が動きません

**A:** 以下を確認してください:

1. `backend/.env` にLLMプロバイダーとAPIキーが設定されているか
2. インターネット接続があるか（Ollama以外）
3. バックエンドのログにエラーが出ていないか

### Q: リスクスコアの計算基準は？

**A:** 以下の要素を総合的に評価します:

- ルール違反の種類と重要度（58ルール）
- 違反の件数と金額の大きさ
- ML異常検知スコア
- Benford分析の乖離度

### Q: 大量データを処理できますか？

**A:** 推奨は100万件以下です。それ以上の場合は期間を分割して処理してください。`BATCH_SIZE` 環境変数で1回の処理件数を調整できます（デフォルト: 10,000件）。

### Q: レポートを編集できますか？

**A:** PowerPoint（.pptx）形式でエクスポートすれば、Microsoft PowerPointやGoogle Slidesで自由に編集できます。

---

## キーボードショートカット

| キー | アクション |
| ---- | --------- |
| `Ctrl + R` | データ更新 |
| `Ctrl + F` | 検索 |
| `Ctrl + P` | レポート生成 |
| `?` | ヘルプ表示 |

---

## サポート

問題が解決しない場合:

1. [トラブルシューティングガイド](15_troubleshooting.md) を確認
2. バックエンドのコンソールログを確認
3. ブラウザの開発者ツール（F12 → Console）を確認
4. [GitHub Issues](https://github.com/GEJFY/journal-ai-auditor/issues) で報告
